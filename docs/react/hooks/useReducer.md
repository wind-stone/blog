# useReducer

è‹¥æƒ³è¯¦ç»†äº†è§£ï¼Œè¯·é˜…è¯»å¦‚ä¸‹å®˜æ–¹æ–‡æ¡£ï¼š

- [React å®˜æ–¹æ–‡æ¡£ - useReducer](https://zh-hans.react.dev/reference/react/useReducer)
- [React å®˜æ–¹æ–‡æ¡£ - è¿ç§»çŠ¶æ€é€»è¾‘è‡³ Reducer ä¸­](https://zh-hans.react.dev/learn/extracting-state-logic-into-a-reducer#comparing-usestate-and-usereducer)

å½“ State åŠå…¶å¤„ç†é€»è¾‘é€æ¸å¢åŠ æ—¶ï¼ˆæ¯”å¦‚ä¸€ä¸ªä»»åŠ¡åˆ—è¡¨çš„ Stateï¼Œå¯¹åº”çš„å¤„ç†é€»è¾‘å¯èƒ½æœ‰å¢åŠ ä»»åŠ¡ã€ä¿®æ”¹ä»»åŠ¡çŠ¶æ€ã€åˆ é™¤ä»»åŠ¡ç­‰ï¼‰ï¼Œä¸ºäº†é™ä½å¤æ‚åº¦ï¼Œå°±éœ€è¦å°†æ‰€æœ‰å¤„ç†é€»è¾‘éƒ½å­˜æ”¾åœ¨ä¸€ä¸ªæ˜“äºç†è§£çš„åœ°æ–¹ï¼Œè€Œåœ¨ç»„ä»¶ä¹‹å¤–æ‰¿è½½è¿™äº›çŠ¶æ€å’Œå¤„ç†é€»è¾‘çš„åœ°æ–¹å°±å« Reducerã€‚

## è§£æƒ‘

### ä¸ºä»€ä¹ˆç§°ä¹‹ä¸º reducer?

å°½ç®¡ `reducer` å¯ä»¥ â€œå‡å°‘â€ ç»„ä»¶å†…çš„ä»£ç é‡ï¼Œä½†å®ƒå®é™…ä¸Šæ˜¯ä»¥æ•°ç»„ä¸Šçš„ `reduce()` æ–¹æ³•å‘½åçš„ã€‚

`reduce()` å…è®¸ä½ å°†æ•°ç»„ä¸­çš„å¤šä¸ªå€¼ â€œç´¯åŠ â€ æˆä¸€ä¸ªå€¼ï¼š

```js
const arr = [1, 2, 3, 4, 5];
const sum = arr.reduce(
  (result, number) => result + number
); // 1 + 2 + 3 + 4 + 5
```

ä½ ä¼ é€’ç»™ `reduce` çš„å‡½æ•°è¢«ç§°ä¸º â€œreducerâ€ã€‚å®ƒæ¥å— ç›®å‰çš„ç»“æœ å’Œ å½“å‰çš„å€¼ï¼Œç„¶åè¿”å› ä¸‹ä¸€ä¸ªç»“æœã€‚React ä¸­çš„ `reducer` å’Œè¿™ä¸ªæ˜¯ä¸€æ ·çš„ï¼šå®ƒä»¬éƒ½æ¥å— ç›®å‰çš„çŠ¶æ€ å’Œ `action` ï¼Œç„¶åè¿”å› ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚è¿™æ ·ï¼Œ`action` ä¼šéšç€æ—¶é—´æ¨ç§»ç´¯ç§¯åˆ°çŠ¶æ€ä¸­ã€‚

### å¯¹æ¯” useState å’Œ useReducer

Reducer å¹¶éæ²¡æœ‰ç¼ºç‚¹ï¼ä»¥ä¸‹æ˜¯æ¯”è¾ƒå®ƒä»¬çš„å‡ ç§æ–¹æ³•ï¼š

- **ä»£ç ä½“ç§¯**ï¼šé€šå¸¸ï¼Œåœ¨ä½¿ç”¨ `useState` æ—¶ï¼Œä¸€å¼€å§‹åªéœ€è¦ç¼–å†™å°‘é‡ä»£ç ã€‚è€Œ `useReducer` å¿…é¡»æå‰ç¼–å†™ `reducer` å‡½æ•°å’Œéœ€è¦è°ƒåº¦çš„ `actions`ã€‚ä½†æ˜¯ï¼Œå½“å¤šä¸ªäº‹ä»¶å¤„ç†ç¨‹åºä»¥ç›¸ä¼¼çš„æ–¹å¼ä¿®æ”¹ `state` æ—¶ï¼Œ`useReducer` å¯ä»¥å‡å°‘ä»£ç é‡ã€‚
- **å¯è¯»æ€§**ï¼šå½“çŠ¶æ€æ›´æ–°é€»è¾‘è¶³å¤Ÿç®€å•æ—¶ï¼Œ`useState` çš„å¯è¯»æ€§è¿˜è¡Œã€‚ä½†æ˜¯ï¼Œä¸€æ—¦é€»è¾‘å˜å¾—å¤æ‚èµ·æ¥ï¼Œå®ƒä»¬ä¼šä½¿ç»„ä»¶å˜å¾—è‡ƒè‚¿ä¸”éš¾ä»¥é˜…è¯»ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`useReducer` å…è®¸ä½ å°†çŠ¶æ€æ›´æ–°é€»è¾‘ä¸äº‹ä»¶å¤„ç†ç¨‹åºåˆ†ç¦»å¼€æ¥ã€‚
- **å¯è°ƒè¯•æ€§**ï¼šå½“ä½¿ç”¨ `useState` å‡ºç°é—®é¢˜æ—¶, ä½ å¾ˆéš¾å‘ç°å…·ä½“åŸå› ä»¥åŠä¸ºä»€ä¹ˆã€‚è€Œä½¿ç”¨ `useReducer` æ—¶ï¼Œä½ å¯ä»¥åœ¨ `reducer` å‡½æ•°ä¸­é€šè¿‡æ‰“å°æ—¥å¿—çš„æ–¹å¼æ¥è§‚å¯Ÿæ¯ä¸ªçŠ¶æ€çš„æ›´æ–°ï¼Œä»¥åŠä¸ºä»€ä¹ˆè¦æ›´æ–°ï¼ˆæ¥è‡ªå“ªä¸ª `action`ï¼‰ã€‚ å¦‚æœæ‰€æœ‰ `action` éƒ½æ²¡é—®é¢˜ï¼Œä½ å°±çŸ¥é“é—®é¢˜å‡ºåœ¨äº† `reducer` æœ¬èº«çš„é€»è¾‘ä¸­ã€‚ç„¶è€Œï¼Œä¸ä½¿ç”¨ `useState` ç›¸æ¯”ï¼Œä½ å¿…é¡»å•æ­¥æ‰§è¡Œæ›´å¤šçš„ä»£ç ã€‚
- **å¯æµ‹è¯•æ€§**ï¼š`reducer` æ˜¯ä¸€ä¸ªä¸ä¾èµ–äºç»„ä»¶çš„çº¯å‡½æ•°ã€‚è¿™å°±æ„å‘³ç€ä½ å¯ä»¥å•ç‹¬å¯¹å®ƒè¿›è¡Œæµ‹è¯•ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æœ€å¥½æ˜¯åœ¨çœŸå®ç¯å¢ƒä¸­æµ‹è¯•ç»„ä»¶ï¼Œä½†å¯¹äºå¤æ‚çš„çŠ¶æ€æ›´æ–°é€»è¾‘ï¼Œé’ˆå¯¹ç‰¹å®šçš„åˆå§‹çŠ¶æ€å’Œ `action`ï¼Œæ–­è¨€ `reducer` è¿”å›çš„ç‰¹å®šçŠ¶æ€ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚
- **ä¸ªäººåå¥½**ï¼šå¹¶ä¸æ˜¯æ‰€æœ‰äººéƒ½å–œæ¬¢ç”¨ `reducer`ï¼Œæ²¡å…³ç³»ï¼Œè¿™æ˜¯ä¸ªäººåå¥½é—®é¢˜ã€‚ä½ å¯ä»¥éšæ—¶åœ¨ `useState` å’Œ `useReducer` ä¹‹é—´åˆ‡æ¢ï¼Œå®ƒä»¬èƒ½åšçš„äº‹æƒ…æ˜¯ä¸€æ ·çš„ï¼

å¦‚æœä½ åœ¨ä¿®æ”¹æŸäº›ç»„ä»¶çŠ¶æ€æ—¶ç»å¸¸å‡ºç°é—®é¢˜æˆ–è€…æƒ³ç»™ç»„ä»¶æ·»åŠ æ›´å¤šé€»è¾‘æ—¶ï¼Œæˆ‘ä»¬å»ºè®®ä½ è¿˜æ˜¯ä½¿ç”¨ `reducer`ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿä¸å¿…æ•´ä¸ªé¡¹ç›®éƒ½ç”¨ `reducer`ï¼Œè¿™æ˜¯å¯ä»¥è‡ªç”±æ­é…çš„ã€‚ä½ ç”šè‡³å¯ä»¥åœ¨ä¸€ä¸ªç»„ä»¶ä¸­åŒæ—¶ä½¿ç”¨ `useState` å’Œ `useReducer`ã€‚

### å¦‚ä½•ç¼–å†™ä¸€ä¸ªå¥½çš„ reducer

é¦–å…ˆï¼Œ**`reducer` éœ€è¦æ˜¯ä¸ªçº¯å‡½æ•°**ï¼Œå³å½“è¾“å…¥ç›¸åŒæ—¶ï¼Œè¾“å‡ºä¹Ÿæ˜¯ç›¸åŒçš„ã€‚å®ƒä»¬ä¸åº”è¯¥åŒ…å«å¼‚æ­¥è¯·æ±‚ã€å®šæ—¶å™¨æˆ–è€…ä»»ä½•å‰¯ä½œç”¨ï¼ˆå¯¹ç»„ä»¶å¤–éƒ¨æœ‰å½±å“çš„æ“ä½œï¼‰ã€‚å®ƒä»¬åº”è¯¥ä»¥ä¸å¯å˜å€¼çš„æ–¹å¼å»æ›´æ–°å¯¹è±¡å’Œæ•°ç»„ï¼Œå› æ­¤å½“ `state` æ˜¯å¯¹è±¡æˆ–æ•°æ®æ—¶ï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹ `state`ï¼Œè€Œæ˜¯åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡æˆ–æ•°æ®ã€‚å¦‚ä¸Šä¸€å°èŠ‚çš„æ‰€ç¤ºã€‚

å…¶æ¬¡ï¼Œ**æ¯ä¸ª `action` éƒ½æè¿°äº†ä¸€ä¸ªå•ä¸€çš„ç”¨æˆ·äº¤äº’**ï¼Œå³ä½¿å®ƒä¼šå¼•å‘æ•°æ®çš„å¤šä¸ªå˜åŒ–ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœç”¨æˆ·åœ¨ä¸€ä¸ªç”± `reducer` ç®¡ç†çš„è¡¨å•ï¼ˆåŒ…å«äº”ä¸ªè¡¨å•é¡¹ï¼‰ä¸­ç‚¹å‡»äº† é‡ç½®æŒ‰é’®ï¼Œé‚£ä¹ˆ `dispatch` ä¸€ä¸ª `reset_form` çš„ `action` æ¯” `dispatch` äº”ä¸ªå•ç‹¬çš„ `set_field` çš„ `action` æ›´åŠ åˆç†ã€‚å¦‚æœä½ åœ¨ä¸€ä¸ª `reducer` ä¸­æ‰“å°äº†æ‰€æœ‰çš„ `action` æ—¥å¿—ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¥å¿—åº”è¯¥æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œå®ƒèƒ½è®©ä½ ä»¥æŸç§æ­¥éª¤å¤ç°å·²å‘ç”Ÿçš„äº¤äº’æˆ–å“åº”ã€‚è¿™å¯¹ä»£ç è°ƒè¯•å¾ˆæœ‰å¸®åŠ©ï¼

## æ³¨æ„äº‹é¡¹

### state æ˜¯åªè¯»çš„ï¼Œå³ä½¿æ˜¯å¯¹è±¡æˆ–æ•°ç»„ä¹Ÿä¸è¦å°è¯•ä¿®æ”¹å®ƒ

```js
function reducer(state, action) {
    switch (action.type) {
        case 'incremented_age': {
            // ğŸš© ä¸è¦åƒä¸‹é¢è¿™æ ·ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„ stateï¼š
            state.age = state.age + 1;
            return state;
        }
    }
}
```

æ­£ç¡®çš„åšæ³•æ˜¯è¿”å›æ–°çš„å¯¹è±¡ï¼š

```js
function reducer(state, action) {
    switch (action.type) {
        case 'incremented_age': {
            // âœ… æ­£ç¡®çš„åšæ³•æ˜¯è¿”å›æ–°çš„å¯¹è±¡
            return {
                ...state,
                age: state.age + 1
            };
        }
    }
}
```

### é¿å…é‡æ–°åˆ›å»ºåˆå§‹å€¼

React ä¼šä¿å­˜ `state` çš„åˆå§‹å€¼å¹¶åœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“æ—¶å¿½ç•¥å®ƒã€‚

```js
function createInitialState(username) {
  // ...
}

function TodoList({ username }) {
  const [state, dispatch] = useReducer(reducer, createInitialState(username));
  // ...
}
```

è™½ç„¶ `createInitialState(username)` çš„è¿”å›å€¼åªç”¨äºåˆæ¬¡æ¸²æŸ“ï¼Œä½†æ˜¯åœ¨æ¯ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™éƒ½ä¼šè¢«è°ƒç”¨ã€‚å¦‚æœå®ƒåˆ›å»ºäº†æ¯”è¾ƒå¤§çš„æ•°ç»„æˆ–è€…æ‰§è¡Œäº†æ˜‚è´µçš„è®¡ç®—å°±ä¼šæµªè´¹æ€§èƒ½ã€‚

ä½ å¯ä»¥é€šè¿‡ç»™ `useReducer` çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ å…¥åˆå§‹åŒ–å‡½æ•°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```js
function createInitialState(username) {
    console.log('createInitialState æ‰§è¡Œ'); // åªä¼šåœ¨ç»„ä»¶åˆå§‹åŒ–æ¸²æŸ“æ—¶æ‰§è¡Œï¼Œåç»­è°ƒç”¨ dispatch ä¿®æ”¹ state å¯¼è‡´é‡æ–°æ¸²æŸ“æ—¶ï¼ŒcreateInitialState ä¸å†æ‰§è¡Œ
    // ...
}

function TodoList({ username }) {
  const [state, dispatch] = useReducer(reducer, username, createInitialState);

  // è°ƒç”¨ dispatch ä¿®æ”¹ state
  // ...
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ä½ ä¼ å…¥çš„å‚æ•°æ˜¯ `createInitialState` è¿™ä¸ªå‡½æ•°è‡ªèº«ï¼Œè€Œä¸æ˜¯æ‰§è¡Œ `createInitialState()` åçš„è¿”å›å€¼ã€‚è¿™æ ·ä¼ å‚å°±å¯ä»¥ä¿è¯åˆå§‹åŒ–å‡½æ•°ä¸ä¼šå†æ¬¡è¿è¡Œã€‚

åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`createInitialState` æœ‰ä¸€ä¸ª `username` å‚æ•°ã€‚å¦‚æœåˆå§‹åŒ–å‡½æ•°ä¸éœ€è¦å‚æ•°å°±å¯ä»¥è®¡ç®—å‡ºåˆå§‹å€¼ï¼Œå¯ä»¥æŠŠ `useReducer` çš„ç¬¬äºŒä¸ªå‚æ•°æ”¹ä¸º `null`ã€‚

### dispatch äº†ä¸€ä¸ª actionï¼Œä¸ä¼šæ”¹å˜å½“å‰æ¸²æŸ“çš„ state

ç±»ä¼¼ `useState`ï¼Œ`useReducer` é‡Œ `dispatch` äº†ä¸€ä¸ª `action`ï¼Œä¸ä¼šæ”¹å˜å½“å‰æ¸²æŸ“çš„ `state`ã€‚

```js
function handleClick() {
  console.log(state.age);  // 42

  dispatch({ type: 'incremented_age' }); // ç”¨ 43 è¿›è¡Œé‡æ–°æ¸²æŸ“ï¼ˆä¸‹ä¸€æ¬¡ï¼‰
  console.log(state.age);  // è¿˜æ˜¯ 42ï¼

  setTimeout(() => {
    console.log(state.age); // ä¸€æ ·æ˜¯ 42ï¼
  }, 5000);
}
```

è¿™æ˜¯å› ä¸º `state` çš„è¡Œä¸ºå’Œå¿«ç…§ä¸€æ ·ã€‚æ›´æ–° `state` ä¼šä½¿ç”¨æ–°çš„å€¼æ¥å¯¹ç»„ä»¶è¿›è¡Œé‡æ–°æ¸²æŸ“ï¼Œä½†æ˜¯ä¸ä¼šæ”¹å˜å½“å‰æ‰§è¡Œçš„äº‹ä»¶å¤„ç†å‡½æ•°é‡Œé¢ `state` çš„å€¼ã€‚

å¦‚æœä½ éœ€è¦è·å–æ›´æ–°åçš„ `state`ï¼Œå¯ä»¥æ‰‹åŠ¨è°ƒç”¨ `reducer` æ¥å¾—åˆ°ç»“æœï¼š

```js
const action = { type: 'incremented_age' };
dispatch(action);

const nextState = reducer(state, action);
console.log(state);     // { age: 42 }
console.log(nextState); // { age: 43 }
```

### æˆ‘æ”¶åˆ°äº†ä¸€ä¸ªæŠ¥é”™ï¼šâ€œToo many re-rendersâ€

ä½ å¯èƒ½ä¼šæ”¶åˆ°è¿™æ ·ä¸€æ¡æŠ¥é”™ä¿¡æ¯ï¼š`Too many re-renders. React limits the number of renders to prevent an infinite loop.`ã€‚è¿™é€šå¸¸æ˜¯åœ¨æ¸²æŸ“æœŸé—´  `dispatch` äº† `action` è€Œå¯¼è‡´ç»„ä»¶è¿›å…¥äº†æ— é™å¾ªç¯ï¼š`dispatch`ï¼ˆä¼šå¯¼è‡´ä¸€æ¬¡é‡æ–°æ¸²æŸ“ï¼‰ã€æ¸²æŸ“ã€`dispatch`ï¼ˆå†æ¬¡å¯¼è‡´é‡æ–°æ¸²æŸ“ï¼‰ï¼Œç„¶åæ— é™å¾ªç¯ã€‚å¤§å¤šæ•°è¿™æ ·çš„é”™è¯¯æ˜¯ç”±äºäº‹ä»¶å¤„ç†å‡½æ•°ä¸­å­˜åœ¨é”™è¯¯çš„é€»è¾‘ï¼š

```js
// ğŸš© é”™è¯¯ï¼šæ¸²æŸ“æœŸé—´è°ƒç”¨äº†å¤„ç†å‡½æ•°
return <button onClick={handleClick()}>Click me</button>

// âœ… ä¿®å¤ï¼šä¼ é€’ä¸€ä¸ªå¤„ç†å‡½æ•°ï¼Œè€Œä¸æ˜¯è°ƒç”¨
return <button onClick={handleClick}>Click me</button>

// âœ… ä¿®å¤ï¼šä¼ é€’ä¸€ä¸ªå†…è”çš„ç®­å¤´å‡½æ•°
return <button onClick={(e) => handleClick(e)}>Click me</button>
```

å¦‚æœä½ æ²¡æœ‰å‘ç°ä¸Šè¿°é”™è¯¯ï¼Œåœ¨æ§åˆ¶å°ç‚¹å¼€æŠ¥é”™æ—è¾¹çš„ç®­å¤´ä»¥æŸ¥çœ‹é”™è¯¯å †æ ˆï¼Œä»ä¸­æŸ¥æ‰¾æ˜¯å“ªä¸ª `dispatch` å‡½æ•°å¼•å‘çš„é”™è¯¯ã€‚

### ä½¿ç”¨ Immer ç®€åŒ– reducer

ä¸åœ¨å¹³å¸¸çš„ `state` ä¸­ä¿®æ”¹å¯¹è±¡å’Œæ•°ç»„ä¸€æ ·ï¼Œä½ å¯ä»¥ä½¿ç”¨ Immer è¿™ä¸ªåº“æ¥ç®€åŒ– `reducer`ã€‚åœ¨è¿™é‡Œï¼Œ`useImmerReducer` è®©ä½ å¯ä»¥é€šè¿‡ `push` æˆ– `arr[i] =` æ¥ä¿®æ”¹ `state`ï¼š

```js
import { useImmerReducer } from 'use-immer';
import AddTask from './AddTask.js';
import TaskList from './TaskList.js';

let nextId = 3;
const initialTasks = [
    {id: 0, text: 'å‚è§‚å¡å¤«å¡åšç‰©é¦†', done: true},
    {id: 1, text: 'çœ‹æœ¨å¶æˆ', done: false},
    {id: 2, text: 'æ‰“å¡åˆ—ä¾¬å¢™', done: false},
];

function tasksReducer(draft, action) {
    switch (action.type) {
        case 'added': {
            // å¯ä»¥ç›´æ¥ä½¿ç”¨ push
            draft.push({
                id: action.id,
                text: action.text,
                done: false,
            });
            break;
        }
        case 'changed': {
            const index = draft.findIndex((t) => t.id === action.task.id);
            // å¯ä»¥ç›´æ¥ä½¿ç”¨ arr[i] = xxx
            draft[index] = action.task;
            break;
        }
        // ...
    }
}

export default function TaskApp() {
    // å°† useReducer æ”¹æˆ useImmerReducer
    const [tasks, dispatch] = useImmerReducer(tasksReducer, initialTasks);

    function handleAddTask(text) {
        dispatch({
            type: 'added',
            id: nextId++,
            text: text,
        });
    }

    function handleChangeTask(task) {
        dispatch({
            type: 'changed',
            task: task,
        });
    }

    return (
        <>
            <h1>å¸ƒæ‹‰æ ¼çš„è¡Œç¨‹å®‰æ’</h1>
            <AddTask onAddTask={handleAddTask} />
            <TaskList
                tasks={tasks}
                onChangeTask={handleChangeTask}
                onDeleteTask={handleDeleteTask}
            />
        </>
    );
}
```

Reducer åº”è¯¥æ˜¯çº¯å‡€çš„ï¼Œæ‰€ä»¥å®ƒä»¬ä¸åº”è¯¥å»ä¿®æ”¹ `state`ã€‚è€Œ Immer ä¸ºä½ æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„ `draft` å¯¹è±¡ï¼Œä½ å¯ä»¥é€šè¿‡å®ƒå®‰å…¨åœ°ä¿®æ”¹ `state`ã€‚

**åœ¨åº•å±‚ï¼ŒImmer ä¼šåŸºäºå½“å‰ `state` åˆ›å»ºä¸€ä¸ªå‰¯æœ¬**ã€‚è¿™å°±æ˜¯é€šè¿‡ `useImmerReducer` æ¥ç®¡ç† `reducer` æ—¶ï¼Œå¯ä»¥ä¿®æ”¹ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¸”ä¸éœ€è¦è¿”å›ä¸€ä¸ªæ–°çš„ `state` çš„åŸå› ã€‚
