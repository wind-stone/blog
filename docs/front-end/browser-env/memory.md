---
sidebarDepth: 0
---

# 内存

[[toc]]

## 执行上下文（Execution Context）

执行上下文是 ECMAScript 标准中定义的抽象概念，用来记录代码运行的环境，可以是代码最开始执行的全局上下文，也可以是执行进入某个函数体内的上下文。

需要注意的是，程序自始至终只能进入一个执行上下文。通常，浏览器用“栈”来维护执行上下文。“栈”遵循“后进先出”的原则。当前起作用的执行上下文位于栈顶，当它内部的代码执行完毕之后出栈，然后将下一个元素作为当前的上下文。

ECMAScript 中已经做出规定，每个执行上下文都有用来追踪执行过程各种状态的记录器。包括：

- 代码执行状态（Code evaluation state）：在当前执行上下文中用来记录代码执行、暂停、重新执行的状态
- 函数（Function）：当前上下文正在执行的函数体（如果当前上下文是脚本或者模块，函数则为 null）
- 范畴（Realm）：内部对象集合，全局运行环境极其作用域下的所有代码，其他相关的状态、资源
- 词法环境（Lexical Environmnet）：用来解决当前上下文中的标识符引用问题
- 变量环境（Variable Environment）：包含环境记录（Environment Record）的词法环境，而环境记录是由变量声明所产生的

## 词法环境（Lexical Environmnet）

ECMAScript 6 中明确定义：词法环境是用来定义标识符和具体变量之间的关系以及基于词法嵌套结构的函数，它包括环境记录和指向外部词法环境的引用（有可能指向 null）。通常词法环境跟一些具体语法结构有关，比如

- 函数声明（Function Declaration）
- 块语句声明（Block Statement）
- Try/Catch 语句，

这些代码在执行的时候都会生成一个新的词法环境。

具体解读如下：

- 用来定义标识符的值：词法环境的目的就是管理代码中的数据。也就是说，它给标识符赋值，让标识符变得有意义。词法环境通过环境记录将标识符和具体的值联系在一起
- 词法环境包含环境记录：环境记录完美地记录了词法环境中所有标识符和具体值之间的联系，并且每个词法环境都有自己的环境记录
- 词法嵌套结构：内部环境引用包含它的外部环境，外部环境还可以有自己的外部环境。因此，一个环境可以作为多个内部环境的外部环境。全局环境是唯一一个没有外部环境的环境。

用伪代码抽象表示为：

```js
LexicalEnviroment = {
    EnvironmnetRecord: {
        // 标识符的赋值操作
    },

    // 外部环境的引用
    outer: <>
}
```

总而言之，每个执行上下文都对应一个词法环境。这个词法环境中记录着变量和它对应的值，还有指向外部环境的引用。它可以是全局环境，模块环境（包括模块之间的引用关系），或函数环境（因函数调用而创建的环境）。

## 作用域链

基于上述词法环境的定义，我们知道一个环境可以访问它的外部环境，它的外部环境又可以继续访问自己的外部环境，以此类推。每个环境能访问到的标识符集合，我们称之为“作用域”。我们将作用域一层一层嵌套，形成了“作用域链”。

这个作用域链，或者说函数的环境链，在函数创建的时候就保存起来了，也就是说，它是由源代码的位置静态定义的。（这就是我们所熟悉的词法作用域 Lexical Scope）

### 给作用于链顶端添加活动对象的方法

- 新建闭包
- catch
- with

### 变量的寻找顺序

### 函数在定义它的作用域中执行，而不是在调用它的作用域里执行

示例代码：

```js
function fn () {
    function innerFn() {
        alert(name);
    };
    var name = "inner";
    return innerFn;
}
var name = "out";
var outerFn = fn();
outerFn();   //  "inner"
```

> 当定义一个函数时，它实际上保存一个作用域链。当调用这个函数时，它创建一个新的对象来存储它的局部变量，并将这个对象添加至保存的作用域链上，同时创建一个新的更长的表示函数调用作用域的“链”。
> -- JavaScript 权威指南（第 6 版 P59
