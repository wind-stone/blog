# 3. 高可用架构：稳定性的核心

前端的高可用，不仅要「治已病」，还要「防未病」。通过合理的架构设计，提高系统对各种异常情况的容错能力，让系统在局部出现问题时，仍然能维持整体的可用性，避免发生雪崩效应：

## 请求冗余

请求冗余是一种常见的高可用架构设计，旨在提高系统对网络故障和服务异常的容错能力。它通过在前端应用中增加请求的副本数量，确保在某个请求失败或超时的情况下，其他请求仍然能够正常执行，从而保证系统的可用性。

具体实现方式包括：

- **备用请求**：在前端应用中，当一个请求地址不可用时，可以请求备用的地址，如多域名或多入口策略。这样可以避免因网络、链路故障而导致的系统不可用。
- **请求重试**：在请求失败或超时的情况下，自动进行重试。重试策略可以根据具体情况进行配置，如指数退避、固定间隔等。
- **请求缓存**：对于一些非实时性要求较高的请求，可以在前端进行缓存。这样即使后端服务出现故障，前端仍然可以返回缓存的结果，提高用户体验。

通过请求冗余的设计，可以有效减少因网络故障或服务异常而导致的系统不可用情况，提高系统的稳定性和可靠性。

比如：CDN 域名容灾，详见：[从0到1：美团端侧CDN容灾解决方案](https://tech.meituan.com/2022/01/13/phoenix-cdn.html)

## 服务降级

服务降级不仅是一个后端的高可用策略，同时也是一个前端的高可用策略。

服务降级是一种在系统负载过高或服务异常时，通过降低服务质量或减少服务功能来保证系统可用性的策略。在前端高可用架构中，服务降级可以应用于以下几个方面：

- **功能降级**：在系统负载过高时，可以暂时关闭一些非核心功能，如评论、分享等，以减轻服务器压力。
- **数据降级**：在数据获取失败或超时的情况下，可以返回默认数据或历史数据，避免因数据缺失而导致的页面错误。
- **界面降级**：在页面渲染失败或加载缓慢的情况下，可以简化页面布局或隐藏部分内容，提高页面的加载速度和可用性。

通过服务降级的设计，可以在系统出现异常情况时，保证核心功能的可用性，提高用户体验。

## 灾备切换

灾备切换是指当系统发生故障或灾难时，能够快速切换到备用系统或备用数据中心，以保障业务的连续性和数据的安全性。在前端高可用架构中，灾备切换通常包括以下几个关键点：

- **多活数据中心**：在不同的地理位置建立多个数据中心，每个数据中心都具备完整的业务处理能力。当某个数据中心发生故障时，可以快速切换到其他数据中心继续提供服务。
- **数据同步**：通过数据同步机制，确保不同数据中心之间的数据保持一致。这样在切换到备用数据中心时，用户的数据不会丢失或出现不一致的情况。
- **自动切换**：建立自动化的灾备切换机制，当检测到故障时，系统能够自动切换到备用数据中心，减少人工干预和故障恢复时间。
- **故障演练**：定期进行故障演练，验证灾备切换机制的有效性，并及时发现和解决潜在的问题。

## 前端限流

参考服务端的限流理念，对一些高频触发的前端操作，也可以在前端侧进行限流。比如对某个按钮的点击，在一定时间内只允许触发一次。或对某个输入框的提交，限制提交频率。前端的限流一方面减少了无谓的请求，另一方面也避免了重复请求对服务端的冲击。

常见的前端限流策略包括：

- **请求频率限制**：限制单位时间内的请求次数，超过限制的请求将被拒绝或延迟处理。
- **并发请求限制**：限制同时处理的请求数量，避免过多的并发请求导致系统资源耗尽。
- **熔断机制**：当后端服务出现故障或响应时间过长时，自动熔断前端请求，防止故障扩散和系统雪崩。

举个请求频率限制且与用户体验相关的例子：前端经常会有点击某个按钮打开新页面的场景，如果不给按钮添加节流，连续点击按钮会打开多个新页面，影响用户体验。因此需要限制按钮 1s 内仅可点击一次。

```js
import throttle from 'lodash.throttle';

const onBtnClick = throttle(fn, 1000, {
    leading: true,
    trailing: false
})
```

## 离线化方案

离线化方案是指通过在前端应用中增加离线功能，使得在网络不可用或不稳定的情况下，用户仍然可以正常使用部分功能。

如 PWA (Progressive Web App) 等离线化技术，将关键的静态资源、数据缓存在本地，即使在无网络的情况下，也能打开页面，执行部分核心功能。这在移动端尤其有用，可以抵御弱网、断网等网络异常。

常见的离线化策略包括：

- **资源缓存**：将静态资源（如 HTML、CSS、JS 等）缓存在本地，使得在离线状态下可以正常加载和渲染页面。
- **数据缓存**：将常用的数据缓存在本地，使得在离线状态下可以正常访问和操作数据。
- **断点续传**：在网络恢复后，自动恢复未完成的操作或数据同步，提高用户体验。

## 故障隔离

利用微前端架构，将一个庞大的前端应用拆分成若干个松耦合的子应用。不同子应用独立开发、独立部署，运行在不同的运行时环境中。当某个子应用出现故障时，不会波及到其他子应用。也可以考虑为每个子应用分配独立的错误监控和告警渠道，做到故障的精细化管理。

故障隔离可以通过合理的架构设计和故障处理机制，将故障的影响范围限制在最小范围内，避免故障扩散和系统崩溃。

## 后端容错

除了前端要做好容错，还要反向要求后端服务也要有足够的容错能力，比如接口的幂等性设计、请求的重试机制、服务的主从切换等。只有前后端协同，共建稳定，才能真正实现全链路的高可用。

后端容错是指通过在后端服务中增加容错机制，提高系统的稳定性和可靠性。常见的后端容错策略包括：

- **幂等性设计**：幂等性是指对同一个接口的多次调用，返回的结果是一致的，不会因为多次调用而产生副作用。幂等性是容错的基础，可以确保在请求重试或者并发调用时，不会引入数据不一致或者重复处理的问题。
- **请求重试机制**：当请求失败时，自动进行重试，直到请求成功或者达到最大重试次数。重试可以提高请求的成功率，减少因为网络抖动、服务瞬时不可用等原因导致的请求失败。但重试也要把握好度，避免无休止的重试加剧系统的负载。
- **服务降级**：当服务负载过高或者出现故障时，主动关闭非核心功能，释放资源确保核心功能的可用性。降级可以防止服务因为过载而完全瘫痪。
- **数据校验**：在接收到前端请求时，对请求参数进行校验，避免因参数错误而导致的系统异常。
- **异常处理**：在服务内部增加异常处理机制，当出现异常时能够进行合理的处理和恢复。
- **服务熔断**：当依赖的下游服务出现故障时，主动切断对下游服务的请求，避免故障传递和放大。熔断可以防止因为个别服务的故障而引发整个系统的级联失败。
- **服务限流**：对请求的速率进行控制，避免服务因为突发的高并发流量而过载。限流可以保护服务的稳定性，避免因为个别客户端的异常流量而影响其他客户端。
- **服务隔离**：将不同的服务部署在不同的机器或者容器中，避免单个服务的故障影响到其他服务。隔离可以提高故障的隔离性和系统的可扩展性。

## 模块化与组件化

模块化和组件化是高可用架构的重要实践，对于提高代码质量、降低维护成本，提高整体可用性有着重要意义。

**模块化**是指将前端代码划分为独立、可复用的模块，每个模块有明确的职责和边界。通过模块化，可以解决前端代码的耦合、重复问题，提高代码的可读性和可维护性。常见的前端模块化规范有 CommonJS、AMD、ES Module 等。

**组件化**是指将 UI 和功能封装为独立、可复用的组件，每个组件有自己的状态、属性、事件等。通过组件化，可以提高 UI 开发的效率和一致性，方便进行功能复用和扩展。现代前端框架如 React、Vue、Angular 等，都提供了组件化的开发模式。

要实践好模块化和组件化，需要遵循以下原则：

- **单一职责**：一个模块或组件只负责一个功能，避免职责混乱。
- **松耦合**：模块或组件之间的依赖关系要明确、最小化，避免紧耦合。
- **可复用**：模块或组件要提供通用的接口，方便在不同场景下复用。
- **可测试**：模块或组件要容易编写单元测试，保证功能的正确性。
- **易维护**：模块或组件的代码要简洁、易读、易修改，降低维护成本。

除了技术实现，模块化和组件化还需要有配套的管理机制，如模块注册、版本管理、文档生成等，以提高复用效率和降低维护成本。

通过模块化和组件化，可以将复杂的前端应用划分为清晰、可管理的模块和组件，提高代码的质量和复用性，降低 Bug 引入的风险，最终提升前端的稳定性。

通过以上几个方面的综合设计和优化，可以有效提高前端应用的高可用性，保障业务的连续性和用户体验。
