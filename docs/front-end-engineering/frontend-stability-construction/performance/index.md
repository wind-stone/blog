# 4. 性能管理：稳定性的保证

性能问题是稳定性的重要威胁之一。页面加载缓慢、交互反馈慢等性能问题，会极大影响用户体验，造成用户流失。因此，性能管理也是稳定性建设的重点领域。

## 性能指标

建立完善的性能指标监控和分析体系。关注各项性能指标，包括白屏时间、首屏时间、用户可交互时间、页面完全加载时间等。根据行业标准和自身业务特点，确立性能的目标值和衡量标准。当某个性能指标达不到目标值时，及时告警并分析原因。

在前面的指标体系和全链路监控中我们有详细讲，这里就不展开了。

不过需要明确的一点是，性能指标是性能管理的开始和结束，是一个闭环，从指标开始，也从指标结束，但是过程中不要盲从于指标，需要多方面的观测及洞察，发现问题及时处理。

## 性能优化

性能问题是影响用户体验和系统稳定性的重要因素，性能管理贯穿于前端应用的整个生命周期，通过性能监控、优化、回归等手段，持续保证系统的性能表现。

通过优化资源、代码、渲染、网络和交互等方面，可以有效提高应用的加载速度、响应速度和运行效率。

### 资源优化

#### 图片/视频优化

- 图片懒加载
- 图片转 Webp，选择适当的图片格式，如 WebP 或 JPEG XR，以减小文件大小。
- 图片 CDN 裁剪，根据实际需求调整图片尺寸，避免不必要的大图加载。
- 视频格式，由 MP4 转为 HLS

#### CSS/JS 优化

合并和压缩 CSS/JS 文件，减少 HTTP 请求次数。使用 CDN 加速静态资源加载，并启用浏览器缓存以减少重复加载。

借助 [webpack-bundle-analyzer](https://github.com/webpack-contrib/webpack-bundle-analyzer) 分析打包文件后，可以对 JS 文件做出如下优化：

- Code Splitting，将低频的功能抽成独立 Chunk，按需加载
- Webpack CommonsChunkPlugin，比如将 Vue 生态的包（Vue、vue-router、vuex/piana）抽成一个独立的 Chunk
- JS 外链引用，比如 VConsole，改成外链引用，且线上在 url 上有特殊参数时才加载

#### 资源懒加载

对于非首屏展示的图片、视频等资源，采用懒加载技术，在用户滚动到可见区域时才进行加载。

#### 第三方包替换

- 用`day.js`代替`moment.js`，在 Antd 项目里可以使用 [antd-dayjs-webpack-plugin](https://github.com/ant-design/antd-dayjs-webpack-plugin) 来一步替换

#### Webpack 插件

- [webpack-bundle-analyzer](https://github.com/webpack-contrib/webpack-bundle-analyzer)，分析构建产物
- [speed-measure-webpack-plugin](https://github.com/stephencookdev/speed-measure-webpack-plugin)，测量 webpack 的构建速度，给出各个插件和 loader 花费的时间
- [hard-source-webpack-plugin](https://github.com/mzgoddard/hard-source-webpack-plugin)，缓存中间模块构建产物，提升本地构建速度
- [progress-bar-webpack-plugin](https://github.com/clessg/progress-bar-webpack-plugin)，以进度条的形式，展示 Webpack 构建速度

### 代码优化

- **减少 DOM 操作**：频繁的 DOM 操作会导致页面重绘和重排，影响性能。应尽量减少 DOM 操作，或使用 DocumentFragment 等技术进行批量更新。
- **事件委托**：使用事件委托技术，将事件处理函数绑定到父元素上，减少事件监听器的创建和内存占用。
- **节流和防抖**：对于频繁触发的事件，如窗口大小变化或滚动事件，使用节流和防抖技术，减少事件处理函数的执行频率。

### 渲染优化

- **避免布局抖动**：减少布局和绘制的频率，避免频繁的样式变化和 DOM 操作。
- **使用 CSS 动画**：相比于 JavaScript 动画，CSS 动画更高效，可以减少 JavaScript 的计算和渲染压力。
- **虚拟滚动**：对于长列表或表格，使用虚拟滚动技术，只渲染可见区域的内容，提高渲染性能。

### 网络优化

- **HTTP2**：使用 HTTP2 协议，利用多路复用和服务器推送等特性，提高网络传输效率。
- **开启 gzip**：也可以使用 CompressionWebpackPlugin 来做 gzip，但是 CDN 上开启 gzip 更方便
- **预加载和预渲染**：对于即将访问的页面或资源，进行预加载或预渲染，减少用户等待时间。
- **优化网络请求**：减少不必要的网络请求，合并请求，使用合适的请求方法和数据格式。

#### 接口

- 推动优化大而慢的接口
- 接口开启 keep-alive
- 域名（包括 HTML 和接口）支持 HTTP2
- HTML 里预请求首屏接口

### 异步加载

- **异步加载 JS/CSS**：将非关键的 JS/CSS 文件设置为异步加载，避免阻塞页面渲染。
- **代码分割**：使用代码分割技术，将代码拆分为多个模块，按需加载，减少初始加载时间。

### 交互优化

- **及时响应用户操作**：确保用户操作得到及时的反馈，包括出错情况的处理。
- **过渡动画平滑自然**：使用平滑自然的过渡动画，提升用户体验。
- **减少用户等待**：优化加载和响应时间，减少用户等待。
- **优化卡顿情况**：确保交互响应迅速，避免卡顿，提供流畅的用户体验。

### 兼容性和健壮性

- **兼容不同设备、系统和浏览器**：确保应用在各种设备、系统和浏览器上都能正常运行。
- **异常和错误处理**：对异常和错误进行妥善处理，保证页面稳定。
- **代码规范和质量控制**：使用代码规范和质量控制流程，减少 bug，提高代码质量和可维护性。

在实施性能优化时，应根据具体情况选择合适的策略，并进行充分的测试和验证，确保优化效果符合预期，同时不会引入新的性能问题或兼容性问题。
